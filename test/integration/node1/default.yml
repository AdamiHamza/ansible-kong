---
- name: Kong Install
  hosts: test-kitchen

  vars:
    kong_version: 0.13.0
    kong_version_current: 0.0.0
    kong_host:  "{{ ansible_eth1.ipv4.address }}"
    kong_cassandra_host: "172.29.129.11"
    kong_proxy_listen:            "{{ kong_host }}:8000"
    kong_proxy_listen_ssl:        "{{ kong_host }}:8443"
    kong_cluster_listen:          "{{ kong_host }}:7946"
    kong_db_update_propagation: 1
    kong_proxy_set_headers:
      "X-Forwarded-Prefix": '$http_x_forwarded_prefix'

  pre_tasks:
    - name: Kong Migrations
      include: "roles/ansible-kong/test/integration/node1/kong-migration.yml"
      when: ansible_os_family|lower == 'debian'

    - name: Set kong host | RedHat
      set_fact: kong_host="{{ ansible_enp0s8.ipv4.address }}"
      when: ansible_service_mgr == 'systemd'

  roles:
    - ansible-kong


- name: Kong Objects Configure
  hosts: test-kitchen

  vars:
    kong_version: 0.13.0
    kong_manage_init_script: true

  pre_tasks:
    - name: Install jq and curl
      apt: name={{ item }} state=present
      with_items: [ jq, curl ]
      when: ansible_os_family|lower == 'debian'

    - name: Install jq and curl
      yum: name={{ item }} state=present
      with_items: [ jq, curl ]
      when: ansible_os_family|lower == 'redhat'

  roles:
    - role: ansible-kong            ## ADD service obj for svcOne
      kong_task: service
      kong_service_config:
        service:
          name: svcOne
          url: "https://service-upstream.ogonna.com/svcOne/api"
        routes:
          - paths: [ "/svcOnePlus" ]
            hosts: [ "a.com", "og.com" ]
          - paths: [ "/svcOne" ]
      kong_delete_service_obj: false
    - role: ansible-kong            ## ADD plugin obj for svcOne service
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        service: svcOne
        #consumer: clientOne
        config: { minute: 20, hour: 500 }
      kong_delete_plugin_obj: false
    - role: ansible-kong            ## ADD plugin obj
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        config: { minute: 50, hour: 500 }
      kong_delete_plugin_obj: false
    - role: ansible-kong            ## UPDATE plugin obj
      kong_task: plugin
      kong_plugin_config:
        name: rate-limiting
        config: { minute: 100, hour: 500 }
      kong_delete_plugin_obj: false
    #- role: ansible-kong            ## DELETE plugin obj for svcOne service
    #  kong_task: plugin
    #  kong_plugin_config:
    #    name: rate-limiting
    #    service: svcOne
    #    config: { minute: 20, hour: 500 }
    #  kong_delete_plugin_obj: true
    #- role: ansible-kong            ## DELETE service obj for svcOne
    #  kong_task: service
    #  kong_service_config:
    #    service:
    #      name: svcOne
    #  kong_delete_service_obj: true
    - role: ansible-kong            ## ADD consumer obj for consumerOne
      kong_task: consumer
      kong_consumer_config:
        username: consumerOne
        custom_id: con-1111
      kong_delete_consumer_obj: false
      kong_use_old_config_format: false
    - role: ansible-kong            ## ADD consumer obj for consumerTwo
      kong_task: consumer
      kong_consumer_config:
        username: consumerTwo
        custom_id: con-2222
      kong_delete_consumer_obj: false
      kong_use_old_config_format: false
    - role: ansible-kong            ## ADD consumer obj for consumerThree
      kong_task: consumer
      kong_consumer_config:
        username: consumerThree
      kong_delete_consumer_obj: false
      kong_use_old_config_format: false
    - role: ansible-kong            ## UPDATE consumer obj for consumerOne
      kong_task: consumer
      kong_consumer_config:
        username: consumerOne
        custom_id: con-1001
      kong_delete_consumer_obj: false
      kong_use_old_config_format: false
    - role: ansible-kong            ## DELETE consumer obj for consumerTwo
      kong_task: consumer
      kong_consumer_config:
        username: consumerTwo
      kong_delete_consumer_obj: true
      kong_use_old_config_format: false

- include: roles/ansible-kong/test/integration/node1/deprecated-config-format.yml
