---
- name: Kong Install
  hosts: test-kitchen

  vars:
    kong_version: 0.8.3
    kong_cassandra_host: "172.29.129.11"
    kong_proxy_listen: "{{ ansible_eth1.ipv4.address }}:8000"
    kong_proxy_listen_ssl: "{{ ansible_eth1.ipv4.address }}:8443"
    kong_proxy_admin_api_listen: "{{ ansible_eth1.ipv4.address }}:8001"
    kong_cluster_listen: "{{ ansible_eth1.ipv4.address }}:7946"
    kong_proxy_set_headers: 
      "X-Forwarded-Prefix": '$http_x_forwarded_prefix'

  roles:
    - ansible-kong


- name: Kong Install
  hosts: test-kitchen

  pre_tasks:
    - name: Install jq and curl
      apt: name={{ item }} state=present
      with_items: [ jq, curl ]

  roles:
    - role: ansible-kong            ## ADD serviceOne
      kong_task: api
      kong_api_obj_name: serviceOne
      kong_api_obj_upstream_url: "https://service-upstream.ogonna.com/serviceOne/api"
      kong_api_obj_request_path: "/serviceOne"
      kong_api_obj_preserve_host: true
      kong_api_obj_strip_request_path: true
    - role: ansible-kong            ## ADD serviceTwo
      kong_task: api
      kong_api_obj_name: serviceTwo
      kong_api_obj_upstream_url: "https://service-upstream.ogonna.com"
      kong_api_obj_request_path: "/serviceTwo"
    - role: ansible-kong            ## UPDATE serviceTwo
      kong_task: api
      kong_api_obj_name: serviceTwo
      kong_api_obj_upstream_url: "https://service-upstream.ogonna.com"
      kong_api_obj_request_path: "/serviceTwoUPDATED"
      kong_api_obj_request_host: "service-upstream.ogonna.com"
    - role: ansible-kong
      kong_task: api
      kong_api_obj_name: serviceThree
      kong_api_obj_upstream_url: "https://service-upstream.ogonna.com"
      kong_api_obj_request_path: "/serviceThree"
      kong_api_obj_preserve_host: true
    - role: ansible-kong
      kong_task: api
      kong_api_obj_name: serviceThree
      kong_api_obj_upstream_url: "https://service-upstream.ogonna.com"
      kong_api_obj_request_path: "/serviceThree"
      kong_delete_api_obj: true
    - role: ansible-kong
      kong_task: api
      kong_api_obj_name: serviceWithPlugins
      kong_api_obj_upstream_url: "https://service-upstream.ogonna.com"
      kong_api_obj_request_path: "/serviceWithPlugins"
      kong_api_obj_plugins:
        - name: oauth2
          consumer_id:
          config_properties:
            - "config.enable_authorization_code=true"
            - "config.scopes=email,phone,address"
            - "config.mandatory_scope=true"
        - name: cors
          consumer_id:
          config_properties:
            - "config.origin=*"
            - "config.methods=GET, POST, PATCH, PUT, DELETE"
            - "config.headers=Accept, Accept-Version, Content-Length, Content-MD5, Content-Type, Date, X-Auth-Token, Access-Control-Allow-Origin, Authorization"
            - "config.exposed_headers=X-Auth-Token"
            - "config.credentials=true"
            - "config.max_age=3600"
    - role: ansible-kong
      kong_task: api
      kong_api_obj_name: serviceWithPlugins
      kong_api_obj_upstream_url: "https://service-upstream.ogonna.com"
      kong_api_obj_request_path: "/serviceWithPlugins"
      kong_api_obj_plugins:
        - name: oauth2
          consumer_id:
          config_properties:
            - "config.enable_authorization_code=true"
            - "config.scopes=email,phone,address"
            - "config.mandatory_scope=true"
