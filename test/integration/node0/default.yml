---
- name: Cassandra Install
  hosts: test-kitchen

  vars:
    java_package: oracle-java8-installer
    #cassandra_distro:  dsc
    #cassandra_version: 2.2.5
    #cassandra_dsc_version: 2.2.5-1

    cassandra_version: 3.7.0
    cassandra_cluster_name: kitchenCluster
    cassandra_listen_address: "{{ ansible_eth1.ipv4.address }}"
    cassandra_rpc_address:    "{{ cassandra_listen_address }}"
    cassandra_seeds:          [ "{{ cassandra_listen_address }}" ]
    cassandra_reinitialize_cluster: false

  pre_tasks:
    - name: Set cassandra listen address | RedHat
      set_fact: cassandra_listen_address="{{ ansible_enp0s8.ipv4.address }}"
      when: ansible_os_family|lower == 'redhat'

  roles:
    - wunzeco.java
    - wunzeco.cassandra

  post_tasks:
    - name: Wait for cassandra to start fully | Debian
      wait_for: host="{{ ansible_eth1.ipv4.address }}" port=9042
      when: ansible_os_family|lower == 'debian'

    - name: Wait for cassandra to start fully | RedHat
      wait_for: host="{{ ansible_enp0s8.ipv4.address }}" port=9042
      when: ansible_os_family|lower == 'redhat'


- name: Kong Install
  hosts: test-kitchen

  vars:
    kong_version: 0.10.3
    ###  &&&&&&&&&&&&&&&&&&  ###
    kong_prereqs: [ openssl, libpcre3, procps, perl ]
    kong_deb_pkg_url: "https://github.com/Mashape/kong/releases/download/{{ kong_version }}/kong-{{ kong_version }}.{{ ansible_distribution_release }}_all.deb"
    kong_conf_dir: /etc/kong
    ###  &&&&&&&&&&&&&&&&&&  ###
    kong_host:  "{{ ansible_eth1.ipv4.address }}"
    kong_cassandra_host:          "{{ kong_host }}"
    kong_proxy_listen:            "{{ kong_host }}:8000"
    kong_proxy_listen_ssl:        "{{ kong_host }}:8443"
    kong_admin_listen:            "{{ kong_host }}:8001"
    kong_cluster_listen:          "{{ kong_host }}:7946"
    kong_proxy_set_headers: 
      "X-Forwarded-Prefix": '$http_x_forwarded_prefix'
    kong_nginx_custom_log_fields: [ realip_remote_addr, http_x_forwarded_prefix, http_x_forwarded_for, http_x_forwarded_proto ]
    kong_nginx_json_log_format_enable: true

  pre_tasks:
    ###  &&&&&&&&&&&&&&&&&&  ###
    - name: START HERE
      debug: msg=starting

    - name: Copy kong_migration_check.sh
      copy:
        src:  roles/ansible-kong/test/kong_migration_check.sh
        dest: /var/tmp/kong_migration_check.sh
        mode: 0755
   
    - name: Check kong version installed
      shell: kong version
      environment:
        PATH: "{{ ansible_env.PATH }}:/usr/local/bin"
      ignore_errors: true
      register: v

    - debug: msg="Installed kong version - {{ v.stdout }}"

    - name: Run kong_migration_check.sh
      shell: /var/tmp/kong_migration_check.sh {{ kong_host }}
      when: v|success
      register: o

    - debug: var=o

    - name: Kong migrations
      block:
        - name: Stop kong (before migration)
          shell: kong stop
          environment:
            PATH: "{{ ansible_env.PATH }}:/usr/local/bin"
          #ignore_errors: true

        - name: Download kong deb package | Debian
          get_url: url="{{ kong_deb_pkg_url }}" dest=/var/tmp validate_certs=no
          when: ansible_os_family|lower == 'debian'

        - name: Install kong prerequisites (Debian/Ubuntu only)
          apt: 
            name: "{{ item }}"
            update_cache: yes
            state: present
          with_items: "{{ kong_prereqs }}"
          when: ansible_os_family|lower == 'debian'

        - name: Install kong | Debian
          apt:
            deb:   "/var/tmp/kong-{{ kong_version }}.{{ ansible_distribution_release }}_all.deb"
            state: present
          when: ansible_os_family|lower == 'debian'

        - name: Run kong migration
          shell: kong migrations up  --conf {{ kong_conf_dir }}/kong.conf
          environment:
            PATH: "{{ ansible_env.PATH }}:/usr/local/bin"
          register: migration

        - debug: var=migration
      when: v.stdout|match('0.9.9') and kong_version|version_compare('0.9.9', '>')

    ###  &&&&&&&&&&&&&&&&&&  ###
    
    - name: Set kong host | RedHat
      set_fact: kong_host="{{ ansible_enp0s8.ipv4.address }}"
      when: ansible_os_family|lower == 'redhat'

  roles:
    - ansible-kong

  ###  &&&&&&&&&&&&&&&&&&  ###
  post_tasks:
    - name: Run kong_migration_check.sh
      shell: /var/tmp/kong_migration_check.sh {{ kong_host }}
  ###  &&&&&&&&&&&&&&&&&&  ###

